# Трансивер "Волк"
Проект DDC-DUC SDR трансивера https://ua3reo.ru/tag/transiver-ua3reo/

## Принцип работы

ВЧ сигнал оцифровывается высокоскоростной микросхемой АЦП, и подаётся на FPGA процессор.<br>
В нём происходит DDC/DUC преобразование (цифровое смещение частоты вниз или вверх по спектру) - по аналогии с приёмником прямого преобразования.<br>
I и Q квадратурные сигналы, полученные в ходе преобразований, поступают на микропроцессор STM32.<br>
В нём происходит фильтрация, (де)модуляция и вывод звука на аудио-кодек/USB. Также он обрабатывает весь пользовательский интерфейс.<br>
При передаче процесс происходит в обратном порядке, только в конце цепочки стоит ЦАП, преобразующий цифровой сигнал обратно в аналоговый ВЧ.<br>

## Технические характеристики

* Частоты приёма: 0 MHz - 750 MHz
* Частоты передачи: 0 MHz - 160 MHz
* Мощность TX: 7Вт+ (HF), 5Вт (VHF)
* Два Антенных входа
* Виды модуляции (TX/RX): CW, LSB, USB, AM, FM, WFM, DIGI
* МШУ(LNA) и Предусилитель
* Регулируемый аттенюатор на 0-31дБ
* Два антенных входа
* Полосовые фильтры
* Динамический диапазон АЦП (16 бит) ~100дБ
* Напряжение питания: 13.8в (защита от перенапряжения и смены полярности)
* Потребляемый ток при приёме: ~0.7А
* Потребляемый ток при передаче: ~2.5А+

## Функции трансивера

* Панорама (спектр+водопад) шириной до 384 кГц
* Несколько видов оформления спектра
* Двойной приёмник (смешивание звука A+B или A&B в стерео)
* Регулируемая полоса пропускания: ФВЧ от 0гц до 600гц, ФНЧ от 100гц до 20кГц
* Встроенный КСВ/Power метр (КВ)
* Автоматический и ручной Notch фильтр
* Отключаемое АРУ (AGC) с регулируемой скоростью атаки
* Карта диапазонов, с возможностью автоматического переключения моды
* Цифровое уменьшение шумов (DNR), подавитель импульсных помех (NB)
* CAT/PTT виртуальные COM-порты (эмуляция FT-450)
* Работа по USB (передача звука, CAT, KEY, PTT)
* CW декодер, самоконтроль, гаусс-фильтр
* Построение графиков КСВ по диапазонам
* Анализатор спектра
* Эквалайзер TX/RX, ревербератор
* Режим сканера
* Режим WSPR маяка
* Поддержка SDHC/SDSC/SDXC карт памяти до 16 Гб
* AGC учитывает особенности человеческого слуха (K-Weighting)
* TCXO стабилизация частоты (возможно использование внешнего источника тактового сигнала, например GPS)
* Работа по WiFi: Синхронизация времени, виртуальный CAT-интерфейс (см. Scheme/WIFI-CAT-instruction.txt), WiFi сервисы
* И другое (см. работу с меню)

### Чувствительность

При соотношении сигнал-шум 10dB, LNA включен, ATT, LPF, BPF выключены

Частота, mHz | Чувствительность, dBm | Чувствительность
------------ | ------------- | -------------
<100	| -131	| 63.0 nV
145	| -128	| 88.9 nV
435	| -121	| 0.2 uV

## Сборка и прошивка

Платы заказывал в китайском сервисе JLCPCB, они и их схемы находятся в папке Scheme.<br>
После сборки необходимо прошить FPGA и STM32 микросхемы.<br>
Прошивка STM32 производится через Keil или по USB шнурку в DFU Mode (скриптом STM32/FLASH.bat). Либо через отладочный шнурок ST-LINK v2. Во время прошивки надо держать зажатой кнопку питания.<br>
Прошивка FPGA происходит через программу Quartus шнурком USB-Blaster.<br>
Правильно собранный аппарат отладки не требует, но при возникновении проблем первым делом надо проверить наличие тактовых сигналов:<br>
90 ножка FGPA и тактовый вход АЦП - 122.88мГц, PC9 ножка STM32 - 12.288мГц, PB10 ножка STM32 - 48кГц.<br>
При необходимости, откалибровать трансивер через соответствующее меню<br>
WiFi модуль ESP-01 должен иметь свежую прошивку с SDK 3.0.4 и выше, и AT командами 1.7.4 и новее<br>
Поддерживаются дисплеи ILI9481, ILI9486, HX8357B, HX8357C, ST7796S, RA8875+GT911

## Управление

* **AF GAIN** - Громкость
* **SHIFT/GAIN** - При активной функции SHIFT - плавная отстройка от выбранной частоты трансивера. При неактивной - регулировка усиления ПЧ
* **ENC MAIN** - Главный энкодер для управления частотой и настройками меню
* **ENC 2** - Вспомогательный энкодер для работы с меню. В обычном режиме быстро переключает частоту, в CW быстро переключает WPM
* **ENC 2[нажатие]** - В режиме CW переключает режим между быстрым шагом и выбором WPM, в остальных режимах открывает свойства полосы пропускания.
* **BAND -** - Переключение на диапазон ниже
* **BAND +** - Переключение на диапазон выше
* **MODE -** - Переключение группы мод SSB->CW->DIGI->FM->AM
* **MODE +** - Переключение подгруппы мод LSB->USB, CW_L->CW_U, DIGI_U->DIGI_L, NFM->WFM, AM->IQ->LOOP
* **FAST** - Режим ускоренной х10 перемотки частоты основным энкодером (настраивается)
* **FAST[зажатие]** - Настройки шага изменения частоты
* **PRE** - Включение предусилителя (МШУ)
* **PRE[зажатие]** - Включение драйвера и/или усилителя АЦП
* **ATT** - Включение аттенюатора
* **REC** - Запись эфира на SD карту
* **MUTE** - Выключение звука
* **MUTE[зажатие]** - Режим сканера сигналов SSB
* **AGC** - Включение АРУ (автоматической регулировки усиления)
* **AGC[зажатие]** - Настройки AGC
* **A=B** - Установка настроек второго банка приёмника равным текущему
* **BW** - Переключение на меню выбора полосы пропускания (LPF)
* **BW[зажатие]** - Переключение на меню выбора полосы пропускания (HPF)
* **TUNE** - Включение несущей для настройки антенны
* **RF POWER** - Выбор мощности передатчика
* **RF POWER[зажатие]** - Настройка шумоподавителя (Squelch)
* **A/B** - Переключение между банками настроек приёмника VFO-A/VFO-B
* **A/B[зажатие]** - Включение автоматической смены моды по бендмапу
* **DOUBLE** - Включение двойного приёмника
* **DOUBLE[зажатие]** - Переключение режимов двойного приёмника A&B (в каждом канале наушников свой тракт) или A+B (смешивание сигналов 2-х приёмников)
* **DNR** - Включение цифрового шумоподавления
* **DNR[зажатие]** - Включение подавителя импульсных помех (NB)
* **NOTCH** - Включение автоматического Notch-фильтра для устранения узкополосной помехи
* **NOTCH[зажатие]** - Включение ручного Notch-фильтра для устранения узкополосной помехи
* **CLAR** - Позволяет разнести передачу и приём на разные банки VFO
* **CLAR[зажатие]** - Включение регулировки SHIFT с лицевой панели
* **WPM** - Переключение на меню выбора скорости ключа (WPM)
* **WPM[зажатие]** - Включение автоматиеского ключа
* **MENU** - Переход в меню
* **MENU[зажатие]** - Включение блокировки клавиатуры LOCK
* **MENU[при включении]** - Сброс настроек трансивера
* **MENU[при включении+PRE]** - Сброс настроек и калибровок трансивера

## Настройки

### TRX Settings

* **RF Power** - Мощность передачи, %
* **Band Map** - Карта диапазонов, автоматически переключает моду в зависимости от частоты
* **AutoGainer** - Автоматическое управление ATT/PREAMP в зависимости от уровня сигнала на АЦП
* **RF Filters** - Управление аппаратными фильтрами (LPF/HPF/BPF)
* **Two Signal tune** - Двухсигнальный генератор в режиме TUNE (1+2кГц)
* **Shift Interval** - Диапазон расстройки SHIFT (+-)
* **TRX Samplerate** - Максимальная ширина панорамы в модах CW/SSB/NFM/DIGI и др.
* **WFM Samplerate** - Максимальная ширина панорамы в моде WFM
* **Freq Step** - Шаг перестройки частоты основным энкодером
* **Freq Step FAST** - Шаг перестройки частоты основным энкодером в режиме FAST
* **Freq Step ENC2** - Шаг перестройки частоты основным доп. энкодером
* **Freq Step ENC2 FAST** - Шаг перестройки частоты основным доп. энкодером в режиме FAST
* **Encoder Accelerate** - Ускорение энкодера на больших оборотах
* **Att step, dB** - Шаг перестройки аттенюатора
* **DEBUG Type** - Вывод отладочной и служебной информации в USB/UART порты
* **Input Type** - Выбор аудио входа (микрофон, линейный вход, USB)
* **Callsign** - Позывной пользователя
* **Locator** - QTH локатор пользователя
* **Transverter Enable** - Включить управление внешним трансвертером
* **Transverter Offset, mHz** - Смещение частоты внешнего трансвертера, мГц

### AUDIO Settings

* **IF Gain, dB** - Усиление ПЧ
* **AGC Gain target, LKFS** - Максимальное усиление AGC (максимальная громкость при включенном АРУ)
* **Mic Gain** - Усиление микрофона
* **DNR xxx** - Подстройка цифрового шумоподавителя
* **SSB HPF Pass** - Частота среза ФНЧ при работе в SSB
* **SSB LPF Pass** - Частота среза ФВЧ при работе в SSB
* **CW LPF Pass** - Частота среза ФНЧ при работе в CW
* **FM LPF Pass** - Частота среза ФНЧ при работе в FM
* **FM Squelch** - Уровень шумодава FM
* **VAD Squelch** - Шумодав SSB на основе технлогии VAD
* **MIC EQ xxx** - Уровни эквалайзера микрофона
* **MIC Reverber** - Ревербератор микрофона
* **RX EQ xxx** - Уровни эквалайзера приёмника
* **RX AGC Speed** - Скорость срабатывания АРУ (автоматического регулятора уровня сигнала) на приём (больше-быстрее)
* **TX Compressor Speed** - Скорость срабатывания АРУ/компрессора на передачу (больше-быстрее)
* **TX Compressor MaxGain** - Максимальное усиление для компрессора
* **Beeper** - Звук нажатия клавиш

### CW Settings

* **CW Key timeout** - Время до остановки режима передачи после отпускания ключа
* **CW Generator shift** - Отстройка генератора приёма от частоты передачи
* **CW Self Hear** - Самоконтроль CW (слышно нажатие ключа)
* **CW Keyer** - Автоматический ключ
* **CW Keyer WPM** - Скорость ключа, WPM
* **CW Gauss filter** - Использовать фильтр с распределением Гаусса (для CW), принимает только пик в центре полосы
* **CW Decoder** - Программный декодер CW приёма

### SCREEN Settings

* **FFT Zoom** - Приближение спектра FFT (X1 - 96кГц, X2 - 48кГц, X4 - 24кГц, X8 - 12кГц, X16 - 6кГц)
* **FFT Zoom CW** - Приближение спектра FFT для CW моды
* **LCD Brightness** - Управление яркостью экрана (не для всех дисплеев)
* **Color Theme** - Выбор темы цветового оформления (0 - черная, 1 - белая, 2 - черная с цветными цифрами)
* **Layout Theme** - Выбор темы оформления интерфейса (0 - по умолчанию)
* **FFT Speed** - Скорость отображения FFT и водопада
* **FFT Automatic** - Автоматическая подстройка шкалы FFT
* **FFT Sensitivity** - Верхний уровень чувствительности автоподстройки FFT (чем меньше - тем сигналы контрастней, 30 - выравнивание по сильнейшему сигналу)
* **FFT Manual Bottom, dBm** - Нижний порог чувствительности FFT при ручной настройке
* **FFT Manual Top, dBm** - Верхний порог чувствительности FFT при ручной настройке
* **FFT Height** - Пропорциональная высота отображения FFT и водопада
* **FFT Style** - Стиль FFT: 1(градиент), 2(заливка), 3(точки), 4(контур)
* **FFT Color** - Цвета FFT и водопада: 1(синий -> желтый -> красный), 2(чёрный -> желтый -> красный), 3(чёрный -> желтый -> зеленый), 4(чёрный -> красный), 5(чёрный -> зеленый), 6(чёрный -> синий), 7(чёрный -> белый)
* **FFT Grid** - Сетка на FFT и водопаде: 1(нет сетки), 2(сетка на FFT), 3(сетка на FFT и водопаде), 4(сетка на водопаде)
* **FFT Background** - Градиентный фон за спектром
* **FFT Lens** - Режим линзы (увеличения центра спектра)
* **FFT Hold Peaks** - Отображать пики сигнала на спектре
* **FFT 3D Mode** - Режим 3D FFT 3D (0 - выкл, 1 - линии, 2 - пиксели)
* **FFT Enabled** - Включение водопада и FFT
* **WTF Moving** - Смещение водопада вместе с изменением частоты
* **FFT Compressor** - Сжимать пики при перегрузке FFT
* **FFT Averaging** - Уровень усреднения всплесков FFT
* **FFT Window** - Выбор окна FFT (1-Dolph–Chebyshev 2-Blackman-Harris 3-Nutall 4-Blackman-Nutall 5-Hann 6-Hamming 7-No window)

### ADC/DAC Settings

* **ADC Driver** - Включение предусилителя-драйвера АЦП
* **ADC Preamp** - Включение предусилителя, встроенного в АЦП
* **ADC Dither** - Включение дизеринга АЦП для приёма слабых сигналов
* **ADC Randomizer** - Включение шифрования цифровой линии АЦП
* **ADC Shutdown** - Выключение АЦП

### WIFI Settings

* **WIFI Enabled** - Включение WiFi модуля (нужен перезапуск)
* **WIFI Network** - Выбор точки доступа WiFi
* **WIFI Network Pass** - Установка пароля для точки доступа WiFi
* **WIFI Timezone** - Временная зона (для обновления времени через интернет)
* **WIFI CAT Server** - Сервер для приёма CAT команд по WIFI
* **WIFI Update ESP firmware** - Запуск автообновления прошивки ESP-01 через интернет (если доступно)

### SD Card

* **USB SD Card Reader** - Режим SD картридера по USB
* **Export Settings** - Экспорт настроек и калибровок на SD карту
* **Import Settings** - Импорт настроек и калибровок с SD карты
* **Format SD card** - Форматирование SD карты

### Calibration [появляется при долгом нажатии кнопки MENU в меню настроек]

* **Encoder invert** - Инвертировать вращение основного энкодера
* **Encoder2 invert** - Инвертировать вращение дополнительного энкодера
* **Encoder debounce** - Время устранения дребезга контактов основного энкодера
* **Encoder2 debounce** - Время устранения дребезга контактов дополнительного энкодера
* **Encoder slow rate** - Коэффициент замедления основного энкодера
* **Encoder on falling** - Энкодер срабатывает только на падение уровня A
* **Encoder acceleration** - Ускорение энкодера при быстром вращении
* **CICCOMP Shift** - Битовое смещение после CIC компенсатора
* **TX CICCOMP Shift** - Битовое смещение после TX CIC компенсатора
* **DAC Shift** - Битовое смещение выхода на ЦАП
* **RF GAIN xx** - Калибровка максимальной выходной мощности на каждый диапазон
* **S METER** - Калибровка S-метра
* **ADC OFFSET** - Калибровка смещения АЦП
* **LPF END** - Параметры ФНЧ фильтра
* **BPF x** - Параметры полосовых фильтров
* **HPF START** - Параметры ФВЧ фильтра
* **SWR FWD/REF RATE** - Подстройка коэффициента трансформации SWR-метра для падающей и отраженной волны
* **VCXO Correction** - Подстройка частоты опорного генератора
* **FAN Medium start** - Температура оконечного каскада для запуска вентилятора на средней скорости
* **FAN Medium stop** - Температура оконечного каскада для остановки вентилятора
* **FAN Full start** - Температура оконечного каскада для запуска вентилятора на полной скорости
* **MAX RF Temp** - Максимальная температура оконечного каскада перед срабатыванием защиты
* **MAX SWR** - Максимальное КСВ перед срабатыванием защиты
* **FM Deviation Scale** - Усиление девиации в FM режиме
* **TUNE Max Power** - Максимальная мощность в режиме настройки
* **RTC COARSE CALIBR** - Грубая калибровка часового кварца, при больших отклонениях
* **RTC FINE CALIBR** - Калибровка часового кварца, одно деление равняется 0.954 ppm

### Set Clock Time

* Установка часов

### Flash update

* Запуск обновления прошивки STM32

### System info

* Вывод системной информации

## Сервисы

### Spectrum Analyzer

* **Spectrum START** - Запуск спектрального анализатора
* **Begin, kHz** - Стартовая частота анализатора с шагом в 1kHz
* **End, kHz** - Конечная частота анализатора с шагом в 1kHz
* **Top, dBm** - Верхний порог графика
* **Bottom, dBm** - Нижний порог графика

### WSPR Beacon

* **WSPR Beacon START** - Запуск маячка WSPR
* **Freq offset** - Смещение относительно центра диапазона WSPR
* **WSPR Band xxx** - Выбор диапазонов для работы маячка

### Band SWR

* Запуск анализатора КСВ в текущем диапазоне

### HF SWR

* Запуск анализатора КСВ во всём КВ диапазоне

### RDA Statistics 

* Отображение статистики по диплому RDA (требуется подключение к интернету)

### Propagination 

* Отображение статистики по прохождению радиоволн (требуется подключение к интернету)

### File Manager 

* Запуск файлового менеджера по SD карте памяти
